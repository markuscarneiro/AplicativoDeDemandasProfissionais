{% extends 'base.html' %}

{% block title %}Dashboard - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="bi bi-speedometer2"></i>
            Dashboard
        </h1>
    </div>
</div>

<!-- Cards de Estatísticas -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total de Demandas
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_demandas }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-clipboard-data fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Atrasadas
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ demandas_atrasadas }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Pendentes
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ demandas_pendentes }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Em Andamento
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ demandas_andamento }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-play-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Gráfico e Alertas -->
<div class="row mb-4">
    <!-- Gráfico de Distribuição por Status -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-pie-chart"></i>
                    Distribuição por Status
                </h6>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Alertas - Demandas Próximas do Prazo -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-warning">
                    <i class="bi bi-bell"></i>
                    Alertas - Próximas do Prazo
                </h6>
                <span class="badge bg-warning">{{ demandas_alerta|length }}</span>
            </div>
            <div class="card-body">
                {% if demandas_alerta %}
                    <div class="list-group list-group-flush">
                        {% for demanda in demandas_alerta %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ demanda.codigo }}</strong><br>
                                <small>{{ demanda.titulo|truncatechars:30 }}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-{% if demanda.esta_atrasada %}danger{% else %}warning{% endif %}">
                                    {{ demanda.data_prazo|date:"d/m/Y" }}
                                    {% if demanda.esta_atrasada %}
                                        <i class="bi bi-exclamation-triangle text-danger"></i>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'demandas:demanda_list' %}?order_by=data_prazo" class="btn btn-sm btn-warning">
                            <i class="bi bi-eye"></i>
                            Ver Todas
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-check-circle display-4 text-success"></i>
                        <p class="text-muted mt-2">Nenhuma demanda próxima do prazo!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Seção de Prioridades e Demandas Recentes -->
<div class="row mb-4">
    <!-- Distribuição por Prioridades -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">
                    <i class="bi bi-bar-chart"></i>
                    Por Prioridade
                </h6>
            </div>
            <div class="card-body">
                {% for prioridade, count in prioridade_stats.items %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>
                        {% if prioridade == 5 %}
                            <span class="badge bg-danger">5 - Muito Alta</span>
                        {% elif prioridade == 4 %}
                            <span class="badge bg-warning">4 - Alta</span>
                        {% elif prioridade == 3 %}
                            <span class="badge bg-info">3 - Média</span>
                        {% elif prioridade == 2 %}
                            <span class="badge bg-light text-dark">2 - Baixa</span>
                        {% else %}
                            <span class="badge bg-secondary">1 - Muito Baixa</span>
                        {% endif %}
                    </span>
                    <span class="badge bg-primary">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Demandas Recentes -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-clock-history"></i>
                    Demandas Recentes
                </h6>
                <a href="{% url 'demandas:demanda_list' %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-eye"></i>
                    Ver Todas
                </a>
            </div>
            <div class="card-body">
                {% if demandas_recentes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Título</th>
                                    <th>Status</th>
                                    <th>Prioridade</th>
                                    <th>Prazo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for demanda in demandas_recentes %}
                                <tr>
                                    <td>
                                        <a href="{% url 'demandas:demanda_detail' demanda.pk %}" class="text-decoration-none">
                                            <code>{{ demanda.codigo }}</code>
                                        </a>
                                    </td>
                                    <td>
                                        <a href="{% url 'demandas:demanda_detail' demanda.pk %}" class="text-decoration-none">
                                            {{ demanda.titulo|truncatechars:40 }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if demanda.status == 'pendente' %}
                                            <span class="badge bg-warning">Pendente</span>
                                        {% elif demanda.status == 'andamento' %}
                                            <span class="badge bg-info">Em Andamento</span>
                                        {% elif demanda.status == 'concluida' %}
                                            <span class="badge bg-success">Concluída</span>
                                        {% elif demanda.status == 'cancelada' %}
                                            <span class="badge bg-danger">Cancelada</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Em Pausa</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if demanda.prioridade == 5 %}
                                            <span class="badge bg-danger">5</span>
                                        {% elif demanda.prioridade == 4 %}
                                            <span class="badge bg-warning">4</span>
                                        {% elif demanda.prioridade == 3 %}
                                            <span class="badge bg-info">3</span>
                                        {% elif demanda.prioridade == 2 %}
                                            <span class="badge bg-light text-dark">2</span>
                                        {% else %}
                                            <span class="badge bg-secondary">1</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="{% if demanda.esta_atrasada %}text-danger{% endif %}">
                                            {{ demanda.data_prazo|date:"d/m/Y" }}
                                            {% if demanda.esta_atrasada %}
                                                <i class="bi bi-exclamation-triangle text-danger"></i>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="text-muted mt-2">Nenhuma demanda encontrada</p>
                        <a href="{% url 'demandas:demanda_create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i>
                            Criar Primeira Demanda
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-lightning"></i>
                    Ações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'demandas:demanda_create' %}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center py-3">
                            <i class="bi bi-plus-circle fa-2x mb-2"></i>
                            <span>Nova Demanda</span>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'demandas:demanda_list' %}" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center py-3">
                            <i class="bi bi-search fa-2x mb-2"></i>
                            <span>Buscar Demandas</span>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'demandas:matriz_eisenhower' %}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center py-3">
                            <i class="bi bi-grid-3x3-gap fa-2x mb-2"></i>
                            <span>Matriz Eisenhower</span>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'admin:index' %}" class="btn btn-outline-secondary w-100 h-100 d-flex flex-column justify-content-center py-3">
                            <i class="bi bi-gear fa-2x mb-2"></i>
                            <span>Administração</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .border-left-primary {
        border-left: 0.25rem solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 0.25rem solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 0.25rem solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }
    
    .border-left-danger {
        border-left: 0.25rem solid #e74a3b !important;
    }
    
    .fa-2x {
        font-size: 2em;
    }
    
    .text-gray-300 {
        color: #dddfeb !important;
    }
    
    .text-gray-800 {
        color: #5a5c69 !important;
    }
    
    .shadow {
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
    }

    .list-group-item {
        border: none;
        border-bottom: 1px solid #e3e6f0;
    }

    .list-group-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gráfico de distribuição por status
const ctx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: {{ status_data.labels|safe }},
        datasets: [{
            data: {{ status_data.data|safe }},
            backgroundColor: {{ status_data.colors|safe }},
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            }
        }
    }
});
</script>
{% endblock %}