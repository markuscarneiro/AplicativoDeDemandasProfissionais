{% extends 'base.html' %}

{% block title %}
    {% if object %}Editar Demanda{% else %}Nova Demanda{% endif %} - {{ block.super }}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="bi bi-{% if object %}pencil{% else %}plus-circle{% endif %}"></i>
                {% if object %}Editar Demanda{% else %}Nova Demanda{% endif %}
            </h1>
            <a href="{% if object %}{% url 'demandas:demanda_detail' object.pk %}{% else %}{% url 'demandas:demanda_list' %}{% endif %}" 
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0">
                    <i class="bi bi-form"></i>
                    Dados da Demanda
                </h6>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <!-- Seção: Identificação -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i>
                                Identificação
                            </h6>
                        </div>
                        
                        <!-- Código (readonly se editando) -->
                        {% if object %}
                        <div class="col-md-4">
                            <label class="form-label">Código</label>
                            <input type="text" class="form-control" value="{{ object.codigo }}" readonly>
                        </div>
                        {% endif %}
                        
                        <!-- Título -->
                        <div class="col-md-{% if object %}8{% else %}12{% endif %}">
                            <label for="{{ form.titulo.id_for_label }}" class="form-label">
                                {{ form.titulo.label }}
                            </label>
                            {{ form.titulo }}
                            {% if form.titulo.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.titulo.errors.0 }}
                                </div>
                            {% endif %}
                            {% if form.titulo.help_text %}
                                <div class="form-text">{{ form.titulo.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Descrição -->
                        <div class="col-12 mt-3">
                            <label for="{{ form.descricao.id_for_label }}" class="form-label">
                                {{ form.descricao.label }}
                            </label>
                            {{ form.descricao }}
                            {% if form.descricao.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.descricao.errors.0 }}
                                </div>
                            {% endif %}
                            {% if form.descricao.help_text %}
                                <div class="form-text">{{ form.descricao.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Seção: Responsabilidades -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-people"></i>
                                Responsabilidades
                            </h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.solicitante.id_for_label }}" class="form-label">
                                {{ form.solicitante.label }}
                            </label>
                            {{ form.solicitante }}
                            {% if form.solicitante.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.solicitante.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.responsavel.id_for_label }}" class="form-label">
                                {{ form.responsavel.label }}
                            </label>
                            {{ form.responsavel }}
                            {% if form.responsavel.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.responsavel.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.projeto.id_for_label }}" class="form-label">
                                {{ form.projeto.label }}
                            </label>
                            {{ form.projeto }}
                            {% if form.projeto.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.projeto.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Seção: Datas -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-calendar"></i>
                                Datas
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.data_prazo.id_for_label }}" class="form-label">
                                {{ form.data_prazo.label }}
                            </label>
                            {{ form.data_prazo }}
                            {% if form.data_prazo.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.data_prazo.errors.0 }}
                                </div>
                            {% endif %}
                            {% if form.data_prazo.help_text %}
                                <div class="form-text">{{ form.data_prazo.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.data_conclusao.id_for_label }}" class="form-label">
                                {{ form.data_conclusao.label }}
                            </label>
                            {{ form.data_conclusao }}
                            {% if form.data_conclusao.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.data_conclusao.errors.0 }}
                                </div>
                            {% endif %}
                            {% if form.data_conclusao.help_text %}
                                <div class="form-text">{{ form.data_conclusao.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Seção: Status e Priorização -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-flag"></i>
                                Status e Priorização
                            </h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.status.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.criticidade.id_for_label }}" class="form-label">
                                {{ form.criticidade.label }}
                            </label>
                            {{ form.criticidade }}
                            {% if form.criticidade.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.criticidade.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.prioridade.id_for_label }}" class="form-label">
                                {{ form.prioridade.label }}
                            </label>
                            {{ form.prioridade }}
                            {% if form.prioridade.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.prioridade.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Seção: Detalhes Técnicos -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-gear"></i>
                                Detalhes Técnicos
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.tempo_estimado.id_for_label }}" class="form-label">
                                {{ form.tempo_estimado.label }}
                            </label>
                            <div class="input-group">
                                {{ form.tempo_estimado }}
                                <span class="input-group-text">horas</span>
                            </div>
                            {% if form.tempo_estimado.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tempo_estimado.errors.0 }}
                                </div>
                            {% endif %}
                            {% if form.tempo_estimado.help_text %}
                                <div class="form-text">{{ form.tempo_estimado.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.tempo_realizado.id_for_label }}" class="form-label">
                                {{ form.tempo_realizado.label }}
                            </label>
                            <div class="input-group">
                                {{ form.tempo_realizado }}
                                <span class="input-group-text">horas</span>
                            </div>
                            {% if form.tempo_realizado.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tempo_realizado.errors.0 }}
                                </div>
                            {% endif %}
                            {% if form.tempo_realizado.help_text %}
                                <div class="form-text">{{ form.tempo_realizado.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12 mt-3">
                            <label for="{{ form.riscos.id_for_label }}" class="form-label">
                                {{ form.riscos.label }}
                            </label>
                            {{ form.riscos }}
                            {% if form.riscos.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.riscos.errors.0 }}
                                </div>
                            {% endif %}
                            {% if form.riscos.help_text %}
                                <div class="form-text">{{ form.riscos.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Seção: Tags -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-tags"></i>
                                Tags
                            </h6>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">{{ form.tags.label }}</label>
                            <div class="row">
                                {% for choice in form.tags %}
                                <div class="col-md-3 col-sm-6 mb-2">
                                    <div class="form-check">
                                        {{ choice.tag }}
                                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                                            {{ choice.choice_label }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if form.tags.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tags.errors.0 }}
                                </div>
                            {% endif %}
                            {% if form.tags.help_text %}
                                <div class="form-text">{{ form.tags.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Botões -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <a href="{% if object %}{% url 'demandas:demanda_detail' object.pk %}{% else %}{% url 'demandas:demanda_list' %}{% endif %}" 
                                   class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i>
                                    Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-{% if object %}check{% else %}plus{% endif %}-circle"></i>
                                    {% if object %}Atualizar Demanda{% else %}Criar Demanda{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-label {
        font-weight: 600;
        color: #495057;
    }
    
    .border-bottom {
        border-bottom: 2px solid #e9ecef !important;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .invalid-feedback {
        font-size: 0.875em;
    }
    
    .form-check {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        transition: all 0.15s ease-in-out;
    }
    
    .form-check:hover {
        background-color: #f8f9fa;
    }
    
    .form-check-input:checked + .form-check-label {
        color: #0d6efd;
        font-weight: 600;
    }
    
    .input-group-text {
        background-color: #e9ecef;
        border-color: #ced4da;
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Validação visual dos campos obrigatórios e melhorias de UX
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const requiredFields = form.querySelectorAll('[required]');
        
        // Configurar datepickers
        const dateFields = form.querySelectorAll('input[type="date"]');
        dateFields.forEach(function(field) {
            // Definir data mínima para campos de data (hoje)
            if (field.name === 'data_prazo') {
                field.min = new Date().toISOString().split('T')[0];
            }
        });
        
        // Contador de caracteres para campos de texto
        const textareaFields = form.querySelectorAll('textarea');
        textareaFields.forEach(function(textarea) {
            const maxLength = textarea.getAttribute('maxlength') || 1000;
            
            // Criar contador
            const counter = document.createElement('small');
            counter.className = 'form-text text-muted char-counter';
            counter.style.float = 'right';
            textarea.parentNode.appendChild(counter);
            
            // Função para atualizar contador
            function updateCounter() {
                const remaining = maxLength - textarea.value.length;
                counter.textContent = `${textarea.value.length}/${maxLength} caracteres`;
                
                if (remaining < 50) {
                    counter.classList.add('text-warning');
                    counter.classList.remove('text-muted');
                } else {
                    counter.classList.add('text-muted');
                    counter.classList.remove('text-warning');
                }
            }
            
            // Event listeners
            textarea.addEventListener('input', updateCounter);
            updateCounter(); // Inicial
        });
        
        // Tooltips para campos com help text
        const fieldsWithHelp = form.querySelectorAll('[data-bs-toggle="tooltip"]');
        fieldsWithHelp.forEach(function(field) {
            new bootstrap.Tooltip(field);
        });
        
        // Validação em tempo real para status e data de conclusão
        const statusField = document.getElementById('id_status');
        const dataConclusaoField = document.getElementById('id_data_conclusao');
        
        if (statusField && dataConclusaoField) {
            statusField.addEventListener('change', function() {
                if (this.value === 'concluida') {
                    dataConclusaoField.required = true;
                    dataConclusaoField.parentNode.querySelector('label').innerHTML += ' <span class="text-danger">*</span>';
                    
                    // Se não tem data de conclusão, definir hoje
                    if (!dataConclusaoField.value) {
                        dataConclusaoField.value = new Date().toISOString().split('T')[0];
                    }
                } else {
                    dataConclusaoField.required = false;
                    const label = dataConclusaoField.parentNode.querySelector('label');
                    label.innerHTML = label.innerHTML.replace(' <span class="text-danger">*</span>', '');
                }
            });
        }
        
        // Validação de datas
        const dataEntradaField = document.getElementById('id_data_entrada');
        const dataPrazoField = document.getElementById('id_data_prazo');
        
        if (dataEntradaField && dataPrazoField) {
            function validarDatas() {
                const dataEntrada = new Date(dataEntradaField.value);
                const dataPrazo = new Date(dataPrazoField.value);
                
                if (dataEntradaField.value && dataPrazoField.value) {
                    if (dataPrazo < dataEntrada) {
                        dataPrazoField.setCustomValidity('A data de prazo não pode ser anterior à data de entrada.');
                        dataPrazoField.classList.add('is-invalid');
                    } else {
                        dataPrazoField.setCustomValidity('');
                        dataPrazoField.classList.remove('is-invalid');
                    }
                }
            }
            
            dataEntradaField.addEventListener('change', validarDatas);
            dataPrazoField.addEventListener('change', validarDatas);
        }
        
        // Adiciona classe de validação aos campos obrigatórios
        requiredFields.forEach(function(field) {
            field.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            });
        });
        
        // Validação do formulário antes do envio
        form.addEventListener('submit', function(e) {
            let isValid = true;
            
            requiredFields.forEach(function(field) {
                if (field.value.trim() === '') {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                    field.classList.add('is-valid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Por favor, preencha todos os campos obrigatórios.');
                // Scroll para o primeiro campo inválido
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
            }
        });
    });
    
    // Auto-resize textarea
    document.querySelectorAll('textarea').forEach(function(textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
</script>
{% endblock %}